name: release-pr

on:
  push:
    branches:
      - develop

jobs:
  release-pr:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Get current timestamp
        id: timestamp
        run: echo "now=$(TZ='Asia/Tokyo' date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
      - name: Create Release PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if there's already an open PR from develop to main with the 'release' label
          existing_pr=$(gh pr list --state open --head develop --base main --label release --json number --jq '.[0].number')
          if [[ "$existing_pr" != 'null' ]] && [[ -n "$existing_pr" ]]; then
            echo "Release PR already exists: #$existing_pr"
            echo 'Updating existing PR title...'
            gh pr edit $existing_pr --title "Release ${{ steps.timestamp.outputs.now }}"
          else
            echo 'Creating new Release PR...'
            pr_url=$(gh pr create --title "Release ${{ steps.timestamp.outputs.now }}" --body 'ðŸ¤– This release PR was automatically generated by [release-pr.yml](https://github.com/himura467/tend-attend/blob/f8d91ec4829d78ca8ae6eae4039e77dfbc25acae/.github/workflows/release-pr.yml)' --head develop --base main)
            pr_number=$(gh pr view "$pr_url" --json number --jq '.number')
            gh pr edit "$pr_number" --add-label 'release'
          fi
